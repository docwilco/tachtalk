<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>TachTalk Configuration</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script>const SSE_PORT = {{SSE_PORT}};</script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            color: #00ff00;
        }
        .threshold {
            background-color: #2a2a2a;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #00ff00;
        }
        .threshold-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .threshold-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #fff;
            background: transparent;
            border: none;
            border-bottom: 1px dashed #666;
            padding: 2px 4px;
            min-width: 100px;
        }
        .threshold-title:focus {
            outline: none;
            border-bottom-color: #00ff00;
        }
        .threshold-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px 15px;
        }
        .threshold-grid .form-group {
            margin: 5px 0;
        }
        .threshold-grid input[type="number"] {
            width: 70px;
        }
        .threshold-buttons {
            margin-top: 8px;
        }
        .threshold-buttons button {
            padding: 5px 10px;
            margin: 2px;
            font-size: 0.9em;
        }
        .form-group {
            margin: 10px 0;
        }
        label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }
        input[type="number"], input[type="color"], input[type="text"], input[type="password"] {
            padding: 5px;
            border: 1px solid #444;
            background-color: #333;
            color: #fff;
            border-radius: 3px;
        }
        input[type="text"], input[type="password"] {
            width: 200px;
        }
        button {
            background-color: #00ff00;
            color: #000;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #00dd00;
        }
        .blink-config {
            background-color: #3a2a2a;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            border-left: 4px solid #ff0000;
        }
        .wifi-config {
            background-color: #2a2a3a;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            border-left: 4px solid #0088ff;
        }
        .ap-mode-banner {
            background-color: #ff8800;
            color: #000;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        #status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
        }
        .success {
            background-color: #2d5016;
            border: 1px solid #00ff00;
        }
        .error {
            background-color: #5a1a1a;
            border: 1px solid #ff0000;
        }
        .mode-indicator {
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 0.9em;
            margin-left: 10px;
        }
        .mode-ap {
            background-color: #ff8800;
            color: #000;
        }
        .mode-client {
            background-color: #00ff00;
            color: #000;
        }
        .network-info {
            background-color: #2a3a2a;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            border-left: 4px solid #00ff00;
        }
        .network-info .info-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #444;
        }
        .network-info .info-row:last-child {
            border-bottom: none;
        }
        .rpm-display {
            font-size: 3em;
            text-align: center;
            color: #00ff00;
            padding: 20px;
            background-color: #2a2a2a;
            border-radius: 10px;
            margin: 20px 0;
        }
        select {
            padding: 5px;
            border: 1px solid #444;
            background-color: #333;
            color: #fff;
            border-radius: 3px;
        }
        .hidden {
            display: none;
        }
        .debug-section {
            background-color: #2a2a3a;
            padding: 10px 15px;
            margin: 20px 0;
            border-radius: 5px;
            border-left: 4px solid #888;
        }
        .debug-section summary {
            cursor: pointer;
            font-weight: bold;
            color: #888;
        }
        .debug-section[open] summary {
            margin-bottom: 10px;
        }
        .debug-content {
            padding: 10px 0;
        }
        .debug-content h3 {
            margin: 10px 0 10px 0;
            font-size: 1em;
            color: #aaa;
        }
        .debug-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 0.9em;
        }
        .raw-config-textarea {
            width: 100%;
            min-height: 300px;
            font-family: monospace;
            font-size: 0.85em;
            background-color: #1a1a1a;
            color: #8f8;
            border: 1px solid #444;
            border-radius: 3px;
            padding: 10px;
            resize: vertical;
            white-space: pre;
            overflow-wrap: normal;
            overflow-x: auto;
        }
        .raw-config-buttons {
            margin-top: 10px;
        }
        .raw-config-buttons button {
            margin-right: 10px;
        }
        .at-commands {
            font-family: monospace;
            font-size: 0.85em;
            color: #8f8;
            word-break: break-all;
        }
        .password-wrapper {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .toggle-password {
            background-color: #444;
            color: #fff;
            padding: 5px 10px;
            border: 1px solid #444;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .toggle-password:hover {
            background-color: #555;
        }
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(0, 0, 0, 0.3);
            border-top-color: #000;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 6px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìà TachTalk Configuration <span id="modeIndicator" class="mode-indicator"></span></h1>
        
        <div id="apBanner" class="ap-mode-banner" style="display: none;">
            ‚ö†Ô∏è Running in Setup Mode - Configure WiFi below to connect to your network
        </div>
        
        <div id="status"></div>
        
        <div class="rpm-display">
            <div>RPM: <span id="currentRpm">---</span></div>
        </div>
        
        <div class="network-info">
            <h2>üåê Network Status</h2>
            <div class="info-row"><span>SSID:</span><span id="netSsid">---</span></div>
            <div class="info-row"><span>IP Address:</span><span id="netIp">---</span></div>
            <div class="info-row"><span>Gateway:</span><span id="netGateway">---</span></div>
            <div class="info-row"><span>Subnet Mask:</span><span id="netSubnet">---</span></div>
            <div class="info-row"><span>DNS:</span><span id="netDns">---</span></div>
            <div class="info-row"><span>MAC Address:</span><span id="netMac">---</span></div>
            <div class="info-row"><span>Signal:</span><span id="netRssi">---</span></div>
        </div>
        
        <details class="debug-section">
            <summary>üîß Debug Info</summary>
            <div class="debug-content">
                <div class="debug-row"><span>Free Heap:</span><span id="freeHeap">---</span></div>
                <div class="debug-row"><span>Min Free Heap:</span><span id="minFreeHeap">---</span></div>
                <h3>AT Commands Received</h3>
                <div id="atCommands" class="at-commands">Loading...</div>
                <h3>OBD2 PIDs Requested</h3>
                <div id="pids" class="pids">Loading...</div>
            </div>
        </details>
        
        <details class="debug-section">
            <summary>üìù Raw Config JSON</summary>
            <div class="debug-content">
                <p style="color: #888; font-size: 0.9em;">Edit the raw configuration JSON. Be careful - invalid JSON will be rejected.</p>
                <textarea id="rawConfigJson" class="raw-config-textarea" spellcheck="false"></textarea>
                <div class="raw-config-buttons">
                    <button id="btnSaveRawConfig" onclick="saveRawConfig()">Save Raw Config</button>
                    <button id="btnReloadRawConfig" onclick="loadRawConfig()">Reload</button>
                    <button onclick="formatRawConfig()">Format JSON</button>
                </div>
            </div>
        </details>
        
        <div class="wifi-config">
            <h2>üì∂ WiFi Configuration</h2>
            <div class="form-group">
                <label>SSID:</label>
                <input type="text" id="wifiSsid" placeholder="Your WiFi network name">
            </div>
            <div class="form-group">
                <label>Password:</label>
                <span class="password-wrapper">
                    <input type="password" id="wifiPassword" placeholder="WiFi password">
                    <button type="button" class="toggle-password" onclick="togglePasswordVisibility()">Show</button>
                </span>
            </div>
            <div class="form-group">
                <label>IP Mode:</label>
                <select id="ipMode" onchange="toggleStaticIp()">
                    <option value="dhcp">DHCP (Automatic)</option>
                    <option value="static">Static IP</option>
                </select>
            </div>
            <div id="staticIpFields" class="hidden">
                <div class="form-group">
                    <label>IP Address:</label>
                    <input type="text" id="staticIp" placeholder="192.168.1.100">
                </div>
                <div class="form-group">
                    <label>Gateway:</label>
                    <input type="text" id="staticGateway" placeholder="192.168.1.1">
                </div>
                <div class="form-group">
                    <label>Subnet Mask:</label>
                    <input type="text" id="staticSubnet" placeholder="255.255.255.0">
                </div>
                <div class="form-group">
                    <label>DNS:</label>
                    <input type="text" id="staticDns" placeholder="8.8.8.8">
                </div>
            </div>
            <button id="btnSaveWifi" onclick="saveWifi()">Save & Connect</button>
            <button id="btnScanWifi" onclick="scanWifi()">Scan Networks</button>
            <div id="wifiNetworks" style="margin-top: 10px;"></div>
        </div>
        
        <div class="wifi-config">
            <h2>üì° Access Point Configuration</h2>
            <div class="form-group">
                <label>AP SSID:</label>
                <input type="text" id="apSsid" placeholder="TachTalk-XXXX (auto)">
                <small style="color: #888;">Leave empty for auto (MAC-based)</small>
            </div>
            <div class="form-group">
                <label>AP Password:</label>
                <span class="password-wrapper">
                    <input type="password" id="apPassword" placeholder="No password (open)">
                    <button type="button" class="toggle-password" onclick="toggleApPasswordVisibility()">Show</button>
                </span>
                <small style="color: #888;">Leave empty for open AP</small>
            </div>
        </div>
        
        <div class="wifi-config">
            <h2>üîå OBD2 Configuration</h2>
            <div class="form-group">
                <label>Dongle IP:</label>
                <input type="text" id="obd2DongleIp" placeholder="192.168.0.10">
            </div>
            <div class="form-group">
                <label>Dongle Port:</label>
                <input type="number" id="obd2DonglePort" placeholder="35000" min="1" max="65535">
            </div>
            <div class="form-group">
                <label>Proxy Listen Port:</label>
                <input type="number" id="obd2ListenPort" placeholder="35000" min="1" max="65535">
            </div>
            <div class="form-group">
                <label>Timeout (ms):</label>
                <input type="number" id="obd2TimeoutMs" placeholder="4500" min="100" max="4500">
                <small style="color: #888;">Max 4500ms</small>
            </div>
        </div>
        
        <div class="wifi-config">
            <h2>‚öôÔ∏è System Settings</h2>
            <div class="form-group">
                <label>Log Level:</label>
                <select id="logLevel">
                    <option value="off">Off</option>
                    <option value="error">Error</option>
                    <option value="warn">Warn</option>
                    <option value="info">Info</option>
                    <option value="debug">Debug</option>
                </select>
            </div>
            <div class="form-group">
                <label>Total LEDs:</label>
                <input type="number" id="totalLeds" value="8">
            </div>
            <div class="form-group">
                <label>LED GPIO Pin:</label>
                <input type="number" id="ledGpio" value="48" min="0" max="48">
                <small style="color: #888;">(requires restart)</small>
            </div>
            <div class="form-group">
                <button id="btnReboot" onclick="rebootDevice()" style="background-color: #ff5500;">üîÑ Reboot Device</button>
            </div>
        </div>
        
        <button id="btnSaveConfig2" onclick="saveConfig()">Save Configuration</button>
        <button id="btnReload2" onclick="loadConfig()">Reload</button>
        
        <h2>RPM Thresholds</h2>
        <div id="thresholds"></div>
        
        <button onclick="addThreshold()">Add Threshold</button>
        
        <button id="btnSaveConfig" onclick="saveConfig()">Save Configuration</button>
        <button id="btnReload" onclick="loadConfig()">Reload</button>
    </div>

    <script>
        function setButtonLoading(btnId, loading, loadingText) {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            if (loading) {
                btn.dataset.originalText = btn.textContent;
                btn.innerHTML = '<span class="spinner"></span>' + (loadingText || btn.textContent);
                btn.disabled = true;
            } else {
                btn.innerHTML = btn.dataset.originalText || btn.textContent.replace(/<[^>]*>/g, '');
                btn.disabled = false;
            }
        }

        let config = {
            wifi: { ssid: '', password: '' },
            ip: { use_dhcp: true, ip: null, gateway: null, subnet: null, dns: null },
            obd2: { dongle_ip: '192.168.0.10', dongle_port: 35000, listen_port: 35000 },
            ap_ssid: null,
            ap_password: null,
            obd2_timeout_ms: 4500,
            log_level: 'info',
            thresholds: [
                { name: 'Off', rpm: 0, start_led: 0, end_led: 0, color: { r: 0, g: 0, b: 0 }, blink: false, blink_ms: 500 },
                { name: 'Blue', rpm: 1000, start_led: 0, end_led: 0, color: { r: 0, g: 0, b: 255 }, blink: false, blink_ms: 500 },
                { name: 'Green', rpm: 1500, start_led: 0, end_led: 0, color: { r: 0, g: 255, b: 0 }, blink: false, blink_ms: 500 },
                { name: 'Yellow', rpm: 2000, start_led: 0, end_led: 0, color: { r: 255, g: 255, b: 0 }, blink: false, blink_ms: 500 },
                { name: 'Red', rpm: 2500, start_led: 0, end_led: 0, color: { r: 255, g: 0, b: 0 }, blink: false, blink_ms: 500 },
                { name: 'Off', rpm: 3000, start_led: 0, end_led: 0, color: { r: 0, g: 0, b: 0 }, blink: false, blink_ms: 500 },
                { name: 'Shift', rpm: 3000, start_led: 0, end_led: 0, color: { r: 0, g: 0, b: 255 }, blink: true, blink_ms: 500 }
            ],
            total_leds: 1,
            led_gpio: 48
        };

        function toggleStaticIp() {
            const mode = document.getElementById('ipMode').value;
            const fields = document.getElementById('staticIpFields');
            fields.className = mode === 'static' ? '' : 'hidden';
        }

        function togglePasswordVisibility() {
            const input = document.getElementById('wifiPassword');
            const button = event.target;
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'Hide';
            } else {
                input.type = 'password';
                button.textContent = 'Show';
            }
        }

        function toggleApPasswordVisibility() {
            const input = document.getElementById('apPassword');
            const button = event.target;
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'Hide';
            } else {
                input.type = 'password';
                button.textContent = 'Show';
            }
        }

        function rgbToHex(color) {
            return '#' + [color.r, color.g, color.b].map(x => {
                const hex = x.toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            }).join('');
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 0, g: 0, b: 0 };
        }

        function renderThresholds() {
            const container = document.getElementById('thresholds');
            container.innerHTML = '';
            
            config.thresholds.forEach((threshold, index) => {
                const div = document.createElement('div');
                div.className = 'threshold';
                const blinkMsHtml = threshold.blink ? 
                    '<div class="form-group">' +
                        '<label>Blink ms:</label>' +
                        '<input type="number" min="50" step="50" value="' + (threshold.blink_ms || 500) + '" onchange="updateThreshold(' + index + ', \'blink_ms\', parseInt(this.value))">' +
                    '</div>' : '<div class="form-group"></div>';
                div.innerHTML = 
                    '<div class="threshold-header">' +
                        '<input type="text" class="threshold-title" value="' + (threshold.name || 'Threshold ' + (index + 1)) + '" onchange="updateThreshold(' + index + ', \'name\', this.value)">' +
                    '</div>' +
                    '<div class="threshold-grid">' +
                        '<div class="form-group">' +
                            '<label>RPM:</label>' +
                            '<input type="number" value="' + threshold.rpm + '" onchange="updateThreshold(' + index + ', \'rpm\', parseInt(this.value))">' +
                        '</div>' +
                        '<div class="form-group">' +
                            '<label>Color:</label>' +
                            '<input type="color" value="' + rgbToHex(threshold.color) + '" onchange="updateThreshold(' + index + ', \'color\', hexToRgb(this.value))">' +
                        '</div>' +
                        '<div class="form-group">' +
                            '<label>From LED:</label>' +
                            '<input type="number" min="0" value="' + threshold.start_led + '" onchange="updateThreshold(' + index + ', \'start_led\', parseInt(this.value))">' +
                        '</div>' +
                        '<div class="form-group">' +
                            '<label>To LED:</label>' +
                            '<input type="number" min="0" value="' + threshold.end_led + '" onchange="updateThreshold(' + index + ', \'end_led\', parseInt(this.value))">' +
                        '</div>' +
                        '<div class="form-group">' +
                            '<label>Blink:</label>' +
                            '<input type="checkbox" ' + (threshold.blink ? 'checked' : '') + ' onchange="updateThreshold(' + index + ', \'blink\', this.checked); renderThresholds();">' +
                        '</div>' +
                        blinkMsHtml +
                    '</div>' +
                    '<div class="threshold-buttons">' +
                        '<button onclick="moveThreshold(' + index + ', -1)">‚ñ≤</button>' +
                        '<button onclick="moveThreshold(' + index + ', 1)">‚ñº</button>' +
                        '<button onclick="removeThreshold(' + index + ')">‚úï</button>' +
                    '</div>';
                container.appendChild(div);
            });
        }

        function updateThreshold(index, field, value) {
            config.thresholds[index][field] = value;
        }

        function addThreshold() {
            config.thresholds.push({
                name: 'New Threshold',
                rpm: 5000,
                start_led: 0,
                end_led: 7,
                color: { r: 255, g: 0, b: 0 },
                blink: false,
                blink_ms: 500
            });
            renderThresholds();
        }

        function moveThreshold(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= config.thresholds.length) return;
            const temp = config.thresholds[index];
            config.thresholds[index] = config.thresholds[newIndex];
            config.thresholds[newIndex] = temp;
            renderThresholds();
        }

        function removeThreshold(index) {
            config.thresholds.splice(index, 1);
            renderThresholds();
        }

        function showStatus(message, isError) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = isError ? 'error' : 'success';
            status.style.display = 'block';
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }

        async function saveConfig() {
            config.total_leds = parseInt(document.getElementById('totalLeds').value);
            config.led_gpio = parseInt(document.getElementById('ledGpio').value);
            config.obd2 = {
                dongle_ip: document.getElementById('obd2DongleIp').value || '192.168.0.10',
                dongle_port: parseInt(document.getElementById('obd2DonglePort').value) || 35000,
                listen_port: parseInt(document.getElementById('obd2ListenPort').value) || 35000
            };
            config.obd2_timeout_ms = parseInt(document.getElementById('obd2TimeoutMs').value) || 4500;
            config.ap_ssid = document.getElementById('apSsid').value || null;
            config.ap_password = document.getElementById('apPassword').value || null;
            config.log_level = document.getElementById('logLevel').value;
            
            setButtonLoading('btnSaveConfig', true, 'Saving...');
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    const result = await response.json().catch(() => ({}));
                    if (result.restart) {
                        showStatus('Configuration saved! Restarting device...', false);
                    } else {
                        showStatus('Configuration saved successfully!', false);
                    }
                } else {
                    showStatus('Failed to save configuration', true);
                }
            } catch (error) {
                showStatus('Error: ' + error.message, true);
            } finally {
                setButtonLoading('btnSaveConfig', false);
            }
        }

        async function saveWifi() {
            const ssid = document.getElementById('wifiSsid').value;
            const password = document.getElementById('wifiPassword').value;
            const useDhcp = document.getElementById('ipMode').value === 'dhcp';
            
            if (!ssid) {
                showStatus('Please enter a WiFi SSID', true);
                return;
            }
            
            const ipConfig = {
                use_dhcp: useDhcp,
                ip: useDhcp ? null : document.getElementById('staticIp').value || null,
                gateway: useDhcp ? null : document.getElementById('staticGateway').value || null,
                subnet: useDhcp ? null : document.getElementById('staticSubnet').value || null,
                dns: useDhcp ? null : document.getElementById('staticDns').value || null
            };
            
            config.wifi = { ssid, password: password || null };
            config.ip = ipConfig;
            
            setButtonLoading('btnSaveWifi', true, 'Connecting...');
            try {
                const response = await fetch('/api/wifi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ssid, password: password || null, ip: ipConfig })
                });
                
                if (response.ok) {
                    showStatus('WiFi saved! Device will restart and connect to ' + ssid, false);
                    setTimeout(() => {
                        showStatus('Restarting device...', false);
                    }, 2000);
                } else {
                    showStatus('Failed to save WiFi configuration', true);
                }
            } catch (error) {
                showStatus('Error: ' + error.message, true);
            } finally {
                setButtonLoading('btnSaveWifi', false);
            }
        }

        async function scanWifi() {
            setButtonLoading('btnScanWifi', true, 'Scanning...');
            try {
                const response = await fetch('/api/wifi/scan');
                if (response.ok) {
                    const networks = await response.json();
                    const container = document.getElementById('wifiNetworks');
                    if (networks.length === 0) {
                        container.innerHTML = '<p>No networks found</p>';
                    } else {
                        container.innerHTML = '<p>Available networks (click to select):</p>' +
                            networks.map(n => 
                                '<button onclick="document.getElementById(\'wifiSsid\').value=\'' + n.ssid + '\'" style="margin: 2px; padding: 5px 10px;">' +
                                    n.ssid +
                                '</button>'
                            ).join('');
                    }
                } else {
                    showStatus('Failed to scan networks', true);
                }
            } catch (error) {
                showStatus('Error: ' + error.message, true);
            } finally {
                setButtonLoading('btnScanWifi', false);
            }
        }

        async function rebootDevice() {
            if (!confirm('Are you sure you want to reboot the device?')) {
                return;
            }
            
            setButtonLoading('btnReboot', true, 'Rebooting...');
            try {
                const response = await fetch('/api/reboot', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    showStatus('Device is rebooting...', false);
                    // Disable the button since device is restarting
                    document.getElementById('btnReboot').disabled = true;
                } else {
                    showStatus('Failed to reboot device', true);
                    setButtonLoading('btnReboot', false);
                }
            } catch (error) {
                // Expected to fail as device disconnects
                showStatus('Device is rebooting...', false);
            }
        }

        async function loadConfig() {
            setButtonLoading('btnReload', true, 'Loading...');
            try {
                const response = await fetch('/api/config');
                if (response.ok) {
                    config = await response.json();
                    document.getElementById('totalLeds').value = config.total_leds;
                    document.getElementById('ledGpio').value = config.led_gpio || 48;
                    document.getElementById('wifiSsid').value = config.wifi?.ssid || '';
                    document.getElementById('wifiPassword').value = config.wifi?.password || '';
                    
                    // IP config
                    const ipConfig = config.ip || { use_dhcp: true };
                    document.getElementById('ipMode').value = ipConfig.use_dhcp ? 'dhcp' : 'static';
                    document.getElementById('staticIp').value = ipConfig.ip || '';
                    document.getElementById('staticGateway').value = ipConfig.gateway || '';
                    document.getElementById('staticSubnet').value = ipConfig.subnet || '';
                    document.getElementById('staticDns').value = ipConfig.dns || '';
                    toggleStaticIp();
                    
                    // OBD2 config
                    const obd2Config = config.obd2 || { dongle_ip: '192.168.0.10', dongle_port: 35000, listen_port: 35000 };
                    document.getElementById('obd2DongleIp').value = obd2Config.dongle_ip || '192.168.0.10';
                    document.getElementById('obd2DonglePort').value = obd2Config.dongle_port || 35000;
                    document.getElementById('obd2ListenPort').value = obd2Config.listen_port || 35000;
                    
                    // Log level
                    document.getElementById('logLevel').value = config.log_level || 'info';
                    
                    // AP config
                    document.getElementById('apSsid').value = config.ap_ssid || '';
                    document.getElementById('apPassword').value = config.ap_password || '';
                    
                    // OBD2 timeout
                    document.getElementById('obd2TimeoutMs').value = config.obd2_timeout_ms || 4500;
                    
                    renderThresholds();
                    showStatus('Configuration loaded!', false);
                } else {
                    showStatus('Failed to load configuration', true);
                }
            } catch (error) {
                showStatus('Error: ' + error.message, true);
            } finally {
                setButtonLoading('btnReload', false);
            }
        }

        async function loadMode() {
            try {
                const response = await fetch('/api/mode');
                if (response.ok) {
                    const data = await response.json();
                    const indicator = document.getElementById('modeIndicator');
                    const banner = document.getElementById('apBanner');
                    if (data.mode === 'ap') {
                        indicator.textContent = 'Setup Mode';
                        indicator.className = 'mode-indicator mode-ap';
                        banner.style.display = 'block';
                    } else {
                        indicator.textContent = 'Connected';
                        indicator.className = 'mode-indicator mode-client';
                        banner.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Failed to load mode:', error);
            }
        }

        async function loadNetworkStatus() {
            try {
                const response = await fetch('/api/network');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('netSsid').textContent = data.ssid || '---';
                    document.getElementById('netIp').textContent = data.ip || '---';
                    document.getElementById('netGateway').textContent = data.gateway || '---';
                    document.getElementById('netSubnet').textContent = data.subnet || '---';
                    document.getElementById('netDns').textContent = data.dns || '---';
                    document.getElementById('netMac').textContent = data.mac || '---';
                    if (data.rssi !== null && data.rssi !== undefined) {
                        let quality;
                        if (data.rssi >= -50) quality = 'Excellent';
                        else if (data.rssi >= -60) quality = 'Good';
                        else if (data.rssi >= -70) quality = 'Fair';
                        else if (data.rssi >= -80) quality = 'Weak';
                        else quality = 'Poor';
                        document.getElementById('netRssi').textContent = quality + ' (' + data.rssi + ' dBm)';
                    } else {
                        document.getElementById('netRssi').textContent = '---';
                    }
                }
            } catch (error) {
                console.error('Failed to load network status:', error);
            }
        }

        async function loadRpm() {
            // RPM is now handled via SSE, this is just a fallback
        }

        let rpmEventSource = null;

        function setupRpmEventSource() {
            // Close existing connection if any
            if (rpmEventSource) {
                rpmEventSource.close();
                rpmEventSource = null;
            }

            // SSE runs on a separate port to avoid blocking the HTTP server
            const sseUrl = `http://${window.location.hostname}:${SSE_PORT}/`;
            rpmEventSource = new EventSource(sseUrl);
            rpmEventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                document.getElementById('currentRpm').textContent = data.rpm !== null ? data.rpm : '---';
            };
            rpmEventSource.onerror = function() {
                document.getElementById('currentRpm').textContent = '---';
                // EventSource will automatically reconnect, no need to manually reconnect
            };
        }

        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        async function loadRawConfig() {
            setButtonLoading('btnReloadRawConfig', true, 'Loading...');
            try {
                const response = await fetch('/api/config');
                if (response.ok) {
                    const cfg = await response.json();
                    document.getElementById('rawConfigJson').value = JSON.stringify(cfg, null, 2);
                    showStatus('Raw config loaded!', false);
                } else {
                    showStatus('Failed to load raw config', true);
                }
            } catch (error) {
                showStatus('Error: ' + error.message, true);
            } finally {
                setButtonLoading('btnReloadRawConfig', false);
            }
        }

        async function saveRawConfig() {
            const textarea = document.getElementById('rawConfigJson');
            let parsed;
            try {
                parsed = JSON.parse(textarea.value);
            } catch (e) {
                showStatus('Invalid JSON: ' + e.message, true);
                return;
            }
            
            setButtonLoading('btnSaveRawConfig', true, 'Saving...');
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(parsed)
                });
                
                if (response.ok) {
                    const result = await response.json().catch(() => ({}));
                    if (result.restart) {
                        showStatus('Raw config saved! Restarting device...', false);
                    } else {
                        showStatus('Raw config saved! Reloading page config...', false);
                        // Reload the main config to sync UI
                        loadConfig();
                    }
                } else {
                    showStatus('Failed to save raw config (server rejected)', true);
                }
            } catch (error) {
                showStatus('Error: ' + error.message, true);
            } finally {
                setButtonLoading('btnSaveRawConfig', false);
            }
        }

        function formatRawConfig() {
            const textarea = document.getElementById('rawConfigJson');
            try {
                const parsed = JSON.parse(textarea.value);
                textarea.value = JSON.stringify(parsed, null, 2);
                showStatus('JSON formatted!', false);
            } catch (e) {
                showStatus('Invalid JSON: ' + e.message, true);
            }
        }

        async function loadDebugInfo() {
            try {
                const response = await fetch('/api/debug_info');
                const info = await response.json();
                
                document.getElementById('freeHeap').textContent = formatBytes(info.free_heap);
                document.getElementById('minFreeHeap').textContent = formatBytes(info.min_free_heap);
                
                const el = document.getElementById('atCommands');
                if (info.at_commands.length === 0) {
                    el.textContent = '(none yet)';
                } else {
                    el.textContent = info.at_commands.join(', ');
                }
                
                const pidEl = document.getElementById('pids');
                if (info.pids.length === 0) {
                    pidEl.textContent = '(none yet)';
                } else {
                    pidEl.textContent = info.pids.join(', ');
                }
            } catch (e) {
                document.getElementById('atCommands').textContent = '(error)';
                document.getElementById('pids').textContent = '(error)';
                document.getElementById('freeHeap').textContent = '---';
                document.getElementById('minFreeHeap').textContent = '---';
            }
        }

        // Initialize
        renderThresholds();
        loadConfig();
        loadMode();
        loadNetworkStatus();
        setupRpmEventSource();
        loadDebugInfo();
        
        // Load raw config when that section is opened
        document.querySelectorAll('.debug-section').forEach(details => {
            details.addEventListener('toggle', (e) => {
                if (e.target.open && e.target.querySelector('#rawConfigJson')) {
                    loadRawConfig();
                }
            });
        });
        
        // Poll network status (RPM uses SSE now)
        setInterval(loadNetworkStatus, 5000);
        // Poll debug info every second (only when debug section is open)
        setInterval(() => {
            const debugSection = document.querySelector('.debug-section:has(#freeHeap)');
            if (debugSection && debugSection.open) loadDebugInfo();
        }, 1000);
    </script>
</body>
</html>
