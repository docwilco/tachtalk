<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>TachTalk Configuration</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script>const SSE_PORT = {{SSE_PORT}};</script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            color: #00ff00;
        }
        .threshold {
            background-color: #2a2a2a;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #00ff00;
        }
        .threshold-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .threshold-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #fff;
            background: transparent;
            border: none;
            border-bottom: 1px dashed #666;
            padding: 2px 4px;
            min-width: 100px;
        }
        .threshold-title:focus {
            outline: none;
            border-bottom-color: #00ff00;
        }
        .threshold-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px 15px;
        }
        .threshold-grid .form-group {
            margin: 5px 0;
        }
        .threshold-grid input[type="number"] {
            width: 70px;
        }
        .threshold-buttons {
            margin-top: 8px;
        }
        .threshold-buttons button {
            padding: 5px 10px;
            margin: 2px;
            font-size: 0.9em;
        }
        .form-group {
            margin: 10px 0;
        }
        label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }
        input[type="number"], input[type="color"], input[type="text"], input[type="password"] {
            padding: 5px;
            border: 1px solid #444;
            background-color: #333;
            color: #fff;
            border-radius: 3px;
        }
        input[type="text"], input[type="password"] {
            width: 200px;
        }
        button {
            background-color: #00ff00;
            color: #000;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #00dd00;
        }
        .blink-config {
            background-color: #3a2a2a;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            border-left: 4px solid #ff0000;
        }
        .wifi-config {
            background-color: #2a2a3a;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            border-left: 4px solid #0088ff;
        }
        #status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
        }
        .success {
            background-color: #2d5016;
            border: 1px solid #00ff00;
        }
        .error {
            background-color: #5a1a1a;
            border: 1px solid #ff0000;
        }
        /* Connection diagram styles */
        .connection-diagram {
            background-color: #1a1a1a;
            padding: 12px;
            margin: 15px 0;
            border-radius: 8px;
            border: 1px solid #333;
        }
        .connection-diagram h2 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .diagram-container {
            display: grid;
            grid-template-columns: auto auto auto;
            grid-template-rows: auto auto auto;
            gap: 2px;
            align-items: center;
            justify-items: center;
            justify-content: center;
            max-width: 340px;
            margin: 0 auto;
        }
        /* Horizontal connectors in top middle cell */
        .horizontal-connectors {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            min-width: 50px;
            cursor: pointer;
        }
        .horizontal-connectors:hover .connector-line {
            opacity: 0.8;
        }
        .horizontal-connectors .diagram-connector {
            padding: 0;
            width: 100%;
        }
        .diagram-node {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 6px;
            background-color: #2a2a2a;
            border-radius: 6px;
            border: 2px solid #444;
            min-width: 60px;
            text-align: center;
        }
        .diagram-node.active {
            border-color: #00ff00;
        }
        .diagram-node .icon {
            font-size: 1.4em;
            margin-bottom: 2px;
        }
        .diagram-node .label {
            font-size: 0.7em;
            color: #aaa;
        }
        .diagram-node .count-large {
            font-size: 1.5em;
            font-weight: bold;
            color: #666;
        }
        .diagram-node.active .count-large {
            color: #00ff00;
        }
        .diagram-connector {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2px 0;
            min-width: 40px;
        }
        .connector-line {
            width: 100%;
            height: 2px;
            background-color: #444;
            position: relative;
        }
        .connector-line.active {
            background-color: #00ff00;
        }
        .connector-line.error {
            background: repeating-linear-gradient(
                90deg,
                #ff4444 0px,
                #ff4444 6px,
                transparent 6px,
                transparent 10px
            );
        }
        .connector-label {
            font-size: 0.65em;
            color: #666;
            margin-top: 3px;
            white-space: nowrap;
        }
        .connector-label.active {
            color: #00ff00;
        }
        .connector-label.error {
            color: #ff4444;
        }
        /* Horizontal parallel connectors (WiFi + TCP) */
        .parallel-connectors-h {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            min-width: 50px;
            cursor: pointer;
        }
        .parallel-connectors-h:hover .connector-line {
            opacity: 0.8;
        }
        .parallel-connectors-h .diagram-connector {
            padding: 0;
            min-width: 100%;
        }
        /* Vertical parallel connectors (HTTP + SSE) */
        .parallel-connectors-v {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 6px;
            justify-content: center;
        }
        .parallel-connectors-v .diagram-connector {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .parallel-connectors-v .connector-line {
            width: 2px;
            height: 20px;
        }
        /* Vertical connector for OBD2 */
        .vertical-connector {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .vertical-connector .connector-line {
            width: 2px;
            height: 20px;
        }
        /* Diagonal connector (top-right to bottom-left) */
        .diagonal-connector {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 45px;
            height: 45px;
            position: relative;
            cursor: pointer;
        }
        .diagonal-connector .connector-line {
            width: 2px;
            height: 55px;
            transform: rotate(45deg);
            position: absolute;
        }
        .diagonal-connector .connector-label {
            position: absolute;
            font-size: 0.6em;
            color: #666;
            background-color: rgba(26, 26, 26, 0.9);
            padding: 1px 3px;
            border-radius: 2px;
        }
        .diagonal-connector .connector-label.active {
            color: #00ff00;
        }
        .diagram-node.clickable {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .diagram-node.clickable:hover {
            background-color: #3a3a3a;
        }
        /* Network details popup */
        .network-details-popup {
            display: none;
            background-color: #2a3a2a;
            padding: 15px;
            margin-top: 15px;
            border-radius: 5px;
            border-left: 4px solid #00ff00;
        }
        .network-details-popup.visible {
            display: block;
        }
        .network-details-popup .info-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #444;
        }
        .network-details-popup .info-row:last-child {
            border-bottom: none;
        }
        .network-info {
            background-color: #2a3a2a;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            border-left: 4px solid #00ff00;
        }
        .network-info .info-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #444;
        }
        .network-info .info-row:last-child {
            border-bottom: none;
        }
        .rpm-display {
            font-size: 3em;
            text-align: center;
            color: #00ff00;
            padding: 20px;
            background-color: #2a2a2a;
            border-radius: 10px;
            margin: 20px 0;
        }
        .brightness-control {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-color: #2a2a2a;
            padding: 15px 20px;
            border-radius: 10px;
            margin: 10px 0 20px 0;
        }
        .brightness-control .brightness-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .brightness-control label {
            width: auto;
            font-weight: bold;
        }
        .brightness-control input[type="range"] {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, #333 0%, #00ff00 100%);
            border-radius: 4px;
            cursor: pointer;
        }
        .brightness-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #00ff00;
            border-radius: 50%;
            cursor: pointer;
        }
        .brightness-control input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #00ff00;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        .brightness-control button {
            padding: 8px 15px;
            margin: 0;
            font-size: 0.9em;
        }
        select {
            padding: 5px;
            border: 1px solid #444;
            background-color: #333;
            color: #fff;
            border-radius: 3px;
        }
        .hidden {
            display: none;
        }
        .debug-section {
            background-color: #2a2a3a;
            padding: 10px 15px;
            margin: 20px 0;
            border-radius: 5px;
            border-left: 4px solid #888;
        }
        .debug-section summary {
            cursor: pointer;
            font-weight: bold;
            color: #888;
        }
        .debug-section[open] summary {
            margin-bottom: 10px;
        }
        .debug-content {
            padding: 10px 0;
        }
        .debug-content h3 {
            margin: 10px 0 10px 0;
            font-size: 1em;
            color: #aaa;
        }
        .debug-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 0.9em;
        }
        .raw-config-textarea {
            width: 100%;
            min-height: 300px;
            font-family: monospace;
            font-size: 0.85em;
            background-color: #1a1a1a;
            color: #8f8;
            border: 1px solid #444;
            border-radius: 3px;
            padding: 10px;
            resize: vertical;
            white-space: pre;
            overflow-wrap: normal;
            overflow-x: auto;
        }
        .raw-config-buttons {
            margin-top: 10px;
        }
        .raw-config-buttons button {
            margin-right: 10px;
        }
        .at-commands {
            font-family: monospace;
            font-size: 0.85em;
            color: #8f8;
            word-break: break-all;
        }
        .password-wrapper {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .toggle-password {
            background-color: #444;
            color: #fff;
            padding: 5px 10px;
            border: 1px solid #444;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .toggle-password:hover {
            background-color: #555;
        }
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(0, 0, 0, 0.3);
            border-top-color: #000;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 6px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìà TachTalk Configuration</h1>
        
        <div id="status"></div>
        
        <div class="rpm-display">
            <div>RPM: <span id="currentRpm">---</span></div>
        </div>
        
        <!-- Brightness Slider -->
        <div class="brightness-control">
            <div class="brightness-header">
                <label for="brightnessSlider">üí° Brightness: <span id="brightnessValue">255</span></label>
                <button id="btnSaveBrightness" onclick="saveBrightness()">Save</button>
            </div>
            <input type="range" id="brightnessSlider" min="0" max="255" value="255" oninput="updateBrightness(this.value)">
        </div>
        
        <!-- Connection Diagram -->
        <div class="connection-diagram">
            <h2>üîó Connection Status</h2>
            <div class="diagram-container">
                <!-- Row 1: OBD2 Dongle | WiFi/TCP | TachTalk -->
                <div class="diagram-node" id="nodeDongle">
                    <span class="icon">üîå</span>
                    <span class="label">OBD2 Dongle</span>
                </div>
                <div class="horizontal-connectors">
                    <div class="diagram-connector" onclick="toggleNetworkDetails()">
                        <div class="connector-line" id="connWifi"></div>
                        <span class="connector-label" id="labelWifi">WiFi</span>
                    </div>
                    <div class="diagram-connector" onclick="toggleTcpDetails()">
                        <div class="connector-line" id="connTcp"></div>
                        <span class="connector-label" id="labelTcp">TCP</span>
                    </div>
                </div>
                <div class="diagram-node" id="nodeDevice">
                    <span class="icon">üì°</span>
                    <span class="label">TachTalk</span>
                </div>
                
                <!-- Row 2: (empty) | Diagonal TCP to clients | HTTP/SSE connectors -->
                <div></div>
                <div class="diagonal-connector" onclick="toggleTcpDetails()">
                    <div class="connector-line" id="connTcpClient"></div>
                    <span class="connector-label" id="labelTcpClient">TCP</span>
                </div>
                <div class="parallel-connectors-v">
                    <div class="vertical-connector">
                        <div class="connector-line active" id="connHttp"></div>
                        <span class="connector-label active" id="labelHttp">HTTP</span>
                    </div>
                    <div class="vertical-connector">
                        <div class="connector-line" id="connSse"></div>
                        <span class="connector-label" id="labelSse">SSE</span>
                    </div>
                </div>
                
                <!-- Row 3: OBD2 Clients | (empty) | Browser -->
                <div class="diagram-node" id="nodeObd2Client">
                    <span class="count-large" id="obd2ClientCount">0</span>
                    <span class="label">OBD2 Clients</span>
                </div>
                <div></div>
                <div class="diagram-node active" id="nodeBrowser">
                    <span class="icon">üåê</span>
                    <span class="label">Browser</span>
                </div>
            </div>
            
            <!-- Network details (shown on click) -->
            <div class="network-details-popup" id="networkDetails">
                <h3 style="margin-top: 0;">üìä Network Details</h3>
                <div class="info-row"><span>SSID:</span><span id="netSsid">---</span></div>
                <div class="info-row"><span>IP Address:</span><span id="netIp">---</span></div>
                <div class="info-row"><span>MAC Address:</span><span id="netMac">---</span></div>
                <div class="info-row"><span>Signal:</span><span id="netRssi">---</span></div>
            </div>
            
            <!-- TCP connection details (shown on click) -->
            <div class="network-details-popup" id="tcpDetails">
                <h3 style="margin-top: 0;">üîå TCP Connections</h3>
                <div id="tcpDongleConnection">
                    <strong>Dongle:</strong>
                    <div class="info-row"><span>Remote:</span><span id="tcpDongleRemote">---</span></div>
                    <div class="info-row"><span>Local:</span><span id="tcpDongleLocal">---</span></div>
                </div>
                <div id="tcpClientConnections" style="margin-top: 10px;">
                    <strong>OBD2 Clients:</strong>
                    <div id="tcpClientList">No clients connected</div>
                </div>
            </div>
        </div>
        
        <details class="debug-section">
            <summary>üîß Debug Info</summary>
            <div class="debug-content">
                <div class="debug-row"><span>Free Heap:</span><span id="freeHeap">---</span></div>
                <div class="debug-row"><span>Min Free Heap:</span><span id="minFreeHeap">---</span></div>
                <h3>Polling Metrics</h3>
                <div class="debug-row"><span>Fast PIDs:</span><span id="metricsFastPids">---</span></div>
                <div class="debug-row"><span>Slow PIDs:</span><span id="metricsSlowPids">---</span></div>
                <div class="debug-row"><span>Requests/sec:</span><span id="metricsReqsPerSec">---</span></div>
                <h3>AT Commands Received</h3>
                <div id="atCommands" class="at-commands">Loading...</div>
                <h3>OBD2 PIDs Requested</h3>
                <div id="pids" class="pids">Loading...</div>
            </div>
        </details>
        
        <details class="debug-section">
            <summary>üìù Raw Config JSON</summary>
            <div class="debug-content">
                <p style="color: #888; font-size: 0.9em;">Edit the raw configuration JSON. Be careful - invalid JSON will be rejected.</p>
                <textarea id="rawConfigJson" class="raw-config-textarea" spellcheck="false"></textarea>
                <div class="raw-config-buttons">
                    <button id="btnSaveRawConfig" onclick="saveRawConfig()">Save Raw Config</button>
                    <button id="btnReloadRawConfig" onclick="loadRawConfig()">Reload</button>
                    <button onclick="formatRawConfig()">Format JSON</button>
                </div>
            </div>
        </details>
        
        <div class="wifi-config">
            <h2>üì∂ WiFi Configuration</h2>
            <div class="form-group">
                <label>SSID:</label>
                <input type="text" id="wifiSsid" placeholder="Your WiFi network name">
            </div>
            <div class="form-group">
                <label>Password:</label>
                <span class="password-wrapper">
                    <input type="password" id="wifiPassword" placeholder="WiFi password">
                    <button type="button" class="toggle-password" onclick="togglePasswordVisibility()">Show</button>
                </span>
            </div>
            <div class="form-group">
                <label>IP Mode:</label>
                <select id="ipMode" onchange="toggleStaticIp()">
                    <option value="dhcp">DHCP (Automatic)</option>
                    <option value="static">Static IP</option>
                </select>
            </div>
            <div id="staticIpFields" class="hidden">
                <div class="form-group">
                    <label>IP/Prefix:</label>
                    <span class="password-wrapper">
                        <input type="text" id="staticIp" placeholder="192.168.0.20" style="width: 140px;">
                        <span>/</span>
                        <input type="number" id="staticPrefixLen" placeholder="24" min="1" max="32" style="width: 50px;">
                    </span>
                </div>
            </div>
            <button id="btnSaveWifi" onclick="saveWifi()">Save & Connect</button>
            <button id="btnScanWifi" onclick="scanWifi()">Scan Networks</button>
            <div id="wifiNetworks" style="margin-top: 10px;"></div>
        </div>
        
        <div class="wifi-config">
            <h2>üì° Access Point Configuration</h2>
            <small style="color: #888; display: block; margin-bottom: 10px;">Changes require reboot to take effect</small>
            <div class="form-group">
                <label>AP SSID:</label>
                <input type="text" id="apSsid" placeholder="TachTalk-XXXX (auto)">
                <br><small style="color: #888;">Leave empty for auto (MAC-based)</small>
            </div>
            <div class="form-group">
                <label>AP Password:</label>
                <span class="password-wrapper">
                    <input type="password" id="apPassword" placeholder="No password (open)">
                    <button type="button" class="toggle-password" onclick="toggleApPasswordVisibility()">Show</button>
                </span>
                <br><small style="color: #888;">Leave empty for open AP</small>
            </div>
            <div class="form-group">
                <label>AP IP/Prefix:</label>
                <span class="password-wrapper">
                    <input type="text" id="apIp" placeholder="10.15.25.1" style="width: 140px;">
                    <span>/</span>
                    <input type="number" id="apPrefixLen" placeholder="24" min="1" max="32" style="width: 50px;">
                </span>
                <br><small style="color: #888;">Default: 10.15.25.1/24</small>
            </div>
        </div>
        
        <div class="wifi-config">
            <h2>üîå OBD2 Configuration</h2>
            <div class="form-group">
                <label>Dongle IP:</label>
                <input type="text" id="obd2DongleIp" placeholder="192.168.0.10">
            </div>
            <div class="form-group">
                <label>Dongle Port:</label>
                <input type="number" id="obd2DonglePort" placeholder="35000" min="1" max="65535">
            </div>
            <div class="form-group">
                <label>Proxy Listen Port:</label>
                <input type="number" id="obd2ListenPort" placeholder="35000" min="1" max="65535">
            </div>
            <div class="form-group">
                <label>Timeout (ms):</label>
                <input type="number" id="obd2TimeoutMs" placeholder="4500" min="100" max="4500">
                <small style="color: #888;">Max 4500ms</small>
            </div>
            <div class="form-group">
                <label>Slow Poll Mode:</label>
                <select id="obd2SlowPollMode" onchange="toggleSlowPollMode()">
                    <option value="interval">Interval (ms)</option>
                    <option value="ratio">Ratio (1 slow per N fast)</option>
                </select>
            </div>
            <div class="form-group" id="slowPollIntervalGroup">
                <label>Slow Poll Interval (ms):</label>
                <input type="number" id="obd2SlowPollMs" placeholder="450" min="50" max="10000">
                <small style="color: #888;">Interval for low-priority PIDs</small>
            </div>
            <div class="form-group hidden" id="slowPollRatioGroup">
                <label>Slow Poll Ratio:</label>
                <input type="number" id="obd2SlowPollRatio" placeholder="6" min="1" max="100">
                <small style="color: #888;">1 slow request per N fast requests</small>
            </div>
            <div class="form-group hidden" id="promotionThresholdGroup">
                <label>Promotion Wait Threshold (ms):</label>
                <input type="number" id="obd2PromotionThreshold" placeholder="20" min="0" max="1000">
                <small style="color: #888;">Promote slow PID to fast if wait exceeds this</small>
            </div>
            <div class="form-group">
                <label>Fast Demotion (ms):</label>
                <input type="number" id="obd2FastDemotionMs" placeholder="2000" min="500" max="30000">
                <small style="color: #888;">Demote to slow after no waiters</small>
            </div>
            <div class="form-group">
                <label>PID Removal (ms):</label>
                <input type="number" id="obd2PidRemovalMs" placeholder="4000" min="1000" max="60000">
                <small style="color: #888;">Remove inactive PIDs after</small>
            </div>
            <div class="form-group">
                <label>Test Multi-PID:</label>
                <input type="checkbox" id="obd2TestMultiPid">
                <small style="color: #888;">Test multi-PID query support at boot (experimental)</small>
            </div>
        </div>
        
        <div class="wifi-config">
            <h2>‚öôÔ∏è System Settings</h2>
            <div class="form-group">
                <label>Log Level:</label>
                <select id="logLevel">
                    <option value="off">Off</option>
                    <option value="error">Error</option>
                    <option value="warn">Warn</option>
                    <option value="info">Info</option>
                    <option value="debug">Debug</option>
                </select>
            </div>
            <div class="form-group">
                <label>Dump CPU Metrics:</label>
                <input type="checkbox" id="dumpCpuMetrics">
                <small style="color: #888;">Print CPU usage to serial every 5s</small>
            </div>
            <div class="form-group">
                <label>Dump Socket Info:</label>
                <input type="checkbox" id="dumpSocketInfo">
                <small style="color: #888;">Print open sockets to serial every 5s</small>
            </div>
            <div class="form-group">
                <label>Total LEDs:</label>
                <input type="number" id="totalLeds" value="8">
            </div>
            <div class="form-group">
                <label>LED GPIO Pin:</label>
                <input type="number" id="ledGpio" value="48" min="0" max="48">
                <small style="color: #888;">(requires restart)</small>
            </div>
            <div class="form-group">
                <button id="btnReboot" onclick="rebootDevice()" style="background-color: #ff5500;">üîÑ Reboot Device</button>
            </div>
        </div>
        
        <button id="btnSaveConfig2" onclick="saveConfig()">Save Configuration</button>
        <button id="btnReload2" onclick="loadConfig()">Reload</button>
        
        <h2>RPM Thresholds</h2>
        <div id="thresholds"></div>
        
        <button onclick="addThreshold()">Add Threshold</button>
        
        <button id="btnSaveConfig" onclick="saveConfig()">Save Configuration</button>
        <button id="btnReload" onclick="loadConfig()">Reload</button>
    </div>

    <script>
        function setButtonLoading(btnId, loading, loadingText) {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            if (loading) {
                btn.dataset.originalText = btn.textContent;
                btn.innerHTML = '<span class="spinner"></span>' + (loadingText || btn.textContent);
                btn.disabled = true;
            } else {
                btn.innerHTML = btn.dataset.originalText || btn.textContent.replace(/<[^>]*>/g, '');
                btn.disabled = false;
            }
        }

        let config = {
            wifi: { ssid: '', password: '' },
            ip: { use_dhcp: true, ip: '192.168.0.20', prefix_len: 24 },
            obd2: {
                dongle_ip: '192.168.0.10',
                dongle_port: 35000,
                listen_port: 35000,
                slow_poll_mode: 'ratio',
                slow_poll_interval_ms: 450,
                slow_poll_ratio: 6,
                promotion_wait_threshold_ms: 40,
                fast_demotion_ms: 2000,
                pid_inactive_removal_ms: 4000,
                test_multi_pid: false
            },
            ap_ssid: '',
            ap_password: null,
            ap_ip: '10.15.25.1',
            ap_prefix_len: 24,
            obd2_timeout_ms: 4500,
            log_level: 'info',
            thresholds: [
                { name: 'Off', rpm: 0, start_led: 0, end_led: 0, color: { r: 0, g: 0, b: 0 }, blink: false, blink_ms: 500 },
                { name: 'Blue', rpm: 1000, start_led: 0, end_led: 0, color: { r: 0, g: 0, b: 255 }, blink: false, blink_ms: 500 },
                { name: 'Green', rpm: 1500, start_led: 0, end_led: 0, color: { r: 0, g: 255, b: 0 }, blink: false, blink_ms: 500 },
                { name: 'Yellow', rpm: 2000, start_led: 0, end_led: 0, color: { r: 255, g: 255, b: 0 }, blink: false, blink_ms: 500 },
                { name: 'Red', rpm: 2500, start_led: 0, end_led: 0, color: { r: 255, g: 0, b: 0 }, blink: false, blink_ms: 500 },
                { name: 'Off', rpm: 3000, start_led: 0, end_led: 0, color: { r: 0, g: 0, b: 0 }, blink: false, blink_ms: 500 },
                { name: 'Shift', rpm: 3000, start_led: 0, end_led: 0, color: { r: 0, g: 0, b: 255 }, blink: true, blink_ms: 500 }
            ],
            total_leds: 1,
            led_gpio: 48
        };

        function toggleStaticIp() {
            const mode = document.getElementById('ipMode').value;
            const fields = document.getElementById('staticIpFields');
            fields.className = mode === 'static' ? '' : 'hidden';
        }

        function toggleSlowPollMode() {
            const mode = document.getElementById('obd2SlowPollMode').value;
            document.getElementById('slowPollIntervalGroup').className = mode === 'interval' ? 'form-group' : 'form-group hidden';
            document.getElementById('slowPollRatioGroup').className = mode === 'ratio' ? 'form-group' : 'form-group hidden';
            document.getElementById('promotionThresholdGroup').className = mode === 'ratio' ? 'form-group' : 'form-group hidden';
        }

        function togglePasswordVisibility() {
            const input = document.getElementById('wifiPassword');
            const button = event.target;
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'Hide';
            } else {
                input.type = 'password';
                button.textContent = 'Show';
            }
        }

        function toggleApPasswordVisibility() {
            const input = document.getElementById('apPassword');
            const button = event.target;
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'Hide';
            } else {
                input.type = 'password';
                button.textContent = 'Show';
            }
        }

        function rgbToHex(color) {
            return '#' + [color.r, color.g, color.b].map(x => {
                const hex = x.toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            }).join('');
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 0, g: 0, b: 0 };
        }

        function renderThresholds() {
            const container = document.getElementById('thresholds');
            container.innerHTML = '';
            
            config.thresholds.forEach((threshold, index) => {
                const div = document.createElement('div');
                div.className = 'threshold';
                const blinkMsHtml = threshold.blink ? 
                    '<div class="form-group">' +
                        '<label>Blink ms:</label>' +
                        '<input type="number" min="50" step="50" value="' + (threshold.blink_ms || 500) + '" onchange="updateThreshold(' + index + ', \'blink_ms\', parseInt(this.value))">' +
                    '</div>' : '<div class="form-group"></div>';
                div.innerHTML = 
                    '<div class="threshold-header">' +
                        '<input type="text" class="threshold-title" value="' + (threshold.name || 'Threshold ' + (index + 1)) + '" onchange="updateThreshold(' + index + ', \'name\', this.value)">' +
                    '</div>' +
                    '<div class="threshold-grid">' +
                        '<div class="form-group">' +
                            '<label>RPM:</label>' +
                            '<input type="number" value="' + threshold.rpm + '" onchange="updateThreshold(' + index + ', \'rpm\', parseInt(this.value))">' +
                        '</div>' +
                        '<div class="form-group">' +
                            '<label>Color:</label>' +
                            '<input type="color" value="' + rgbToHex(threshold.color) + '" onchange="updateThreshold(' + index + ', \'color\', hexToRgb(this.value))">' +
                        '</div>' +
                        '<div class="form-group">' +
                            '<label>From LED:</label>' +
                            '<input type="number" min="0" value="' + threshold.start_led + '" onchange="updateThreshold(' + index + ', \'start_led\', parseInt(this.value))">' +
                        '</div>' +
                        '<div class="form-group">' +
                            '<label>To LED:</label>' +
                            '<input type="number" min="0" value="' + threshold.end_led + '" onchange="updateThreshold(' + index + ', \'end_led\', parseInt(this.value))">' +
                        '</div>' +
                        '<div class="form-group">' +
                            '<label>Blink:</label>' +
                            '<input type="checkbox" ' + (threshold.blink ? 'checked' : '') + ' onchange="updateThreshold(' + index + ', \'blink\', this.checked); renderThresholds();">' +
                        '</div>' +
                        blinkMsHtml +
                    '</div>' +
                    '<div class="threshold-buttons">' +
                        '<button onclick="moveThreshold(' + index + ', -1)">‚ñ≤</button>' +
                        '<button onclick="moveThreshold(' + index + ', 1)">‚ñº</button>' +
                        '<button onclick="removeThreshold(' + index + ')">‚úï</button>' +
                    '</div>';
                container.appendChild(div);
            });
        }

        function updateThreshold(index, field, value) {
            config.thresholds[index][field] = value;
        }

        function addThreshold() {
            config.thresholds.push({
                name: 'New Threshold',
                rpm: 5000,
                start_led: 0,
                end_led: 7,
                color: { r: 255, g: 0, b: 0 },
                blink: false,
                blink_ms: 500
            });
            renderThresholds();
        }

        function moveThreshold(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= config.thresholds.length) return;
            const temp = config.thresholds[index];
            config.thresholds[index] = config.thresholds[newIndex];
            config.thresholds[newIndex] = temp;
            renderThresholds();
        }

        function removeThreshold(index) {
            config.thresholds.splice(index, 1);
            renderThresholds();
        }

        function showStatus(message, isError) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = isError ? 'error' : 'success';
            status.style.display = 'block';
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }

        async function saveConfig() {
            config.total_leds = parseInt(document.getElementById('totalLeds').value);
            config.led_gpio = parseInt(document.getElementById('ledGpio').value);
            config.obd2 = {
                dongle_ip: document.getElementById('obd2DongleIp').value || '192.168.0.10',
                dongle_port: parseInt(document.getElementById('obd2DonglePort').value) || 35000,
                listen_port: parseInt(document.getElementById('obd2ListenPort').value) || 35000,
                slow_poll_mode: document.getElementById('obd2SlowPollMode').value || 'ratio',
                slow_poll_interval_ms: parseInt(document.getElementById('obd2SlowPollMs').value) || 450,
                slow_poll_ratio: parseInt(document.getElementById('obd2SlowPollRatio').value) || 6,
                promotion_wait_threshold_ms: parseInt(document.getElementById('obd2PromotionThreshold').value) || 20,
                fast_demotion_ms: parseInt(document.getElementById('obd2FastDemotionMs').value) || 2000,
                pid_inactive_removal_ms: parseInt(document.getElementById('obd2PidRemovalMs').value) || 4000,
                test_multi_pid: document.getElementById('obd2TestMultiPid').checked
            };
            config.obd2_timeout_ms = parseInt(document.getElementById('obd2TimeoutMs').value) || 4500;
            config.ap_ssid = document.getElementById('apSsid').value;
            config.ap_password = document.getElementById('apPassword').value || null;
            config.ap_ip = document.getElementById('apIp').value || '10.15.25.1';
            config.ap_prefix_len = parseInt(document.getElementById('apPrefixLen').value) || 24;
            config.log_level = document.getElementById('logLevel').value;
            config.dump_cpu_metrics = document.getElementById('dumpCpuMetrics').checked;
            config.dump_socket_info = document.getElementById('dumpSocketInfo').checked;
            
            setButtonLoading('btnSaveConfig', true, 'Saving...');
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    const result = await response.json().catch(() => ({}));
                    if (result.restart) {
                        showStatus('Configuration saved! Restarting device...', false);
                    } else {
                        showStatus('Configuration saved successfully!', false);
                    }
                } else {
                    showStatus('Failed to save configuration', true);
                }
            } catch (error) {
                showStatus('Error: ' + error.message, true);
            } finally {
                setButtonLoading('btnSaveConfig', false);
            }
        }

        // Throttle state for brightness slider
        let lastBrightnessUpdate = 0;
        let pendingBrightnessValue = null;
        let brightnessThrottleTimer = null;

        function updateBrightness(value) {
            document.getElementById('brightnessValue').textContent = value;
            
            const now = Date.now();
            const elapsed = now - lastBrightnessUpdate;
            
            if (elapsed >= 30) {
                // Enough time has passed, send immediately
                lastBrightnessUpdate = now;
                sendBrightnessUpdate(value);
            } else {
                // Throttled: schedule update for remaining time
                pendingBrightnessValue = value;
                if (!brightnessThrottleTimer) {
                    brightnessThrottleTimer = setTimeout(() => {
                        brightnessThrottleTimer = null;
                        lastBrightnessUpdate = Date.now();
                        sendBrightnessUpdate(pendingBrightnessValue);
                    }, 30 - elapsed);
                }
            }
        }

        function sendBrightnessUpdate(value) {
            fetch('/api/brightness', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ brightness: parseInt(value), save: false })
            }).catch(err => console.error('Brightness update failed:', err));
        }

        async function saveBrightness() {
            const brightness = parseInt(document.getElementById('brightnessSlider').value);
            setButtonLoading('btnSaveBrightness', true, 'Saving...');
            try {
                const response = await fetch('/api/brightness', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ brightness: brightness, save: true })
                });
                
                if (response.ok) {
                    showStatus('Brightness saved!', false);
                } else {
                    showStatus('Failed to save brightness', true);
                }
            } catch (error) {
                showStatus('Error: ' + error.message, true);
            } finally {
                setButtonLoading('btnSaveBrightness', false);
            }
        }

        async function saveWifi() {
            const ssid = document.getElementById('wifiSsid').value;
            const password = document.getElementById('wifiPassword').value;
            const useDhcp = document.getElementById('ipMode').value === 'dhcp';
            
            if (!ssid) {
                showStatus('Please enter a WiFi SSID', true);
                return;
            }
            
            const ipConfig = {
                use_dhcp: useDhcp,
                ip: document.getElementById('staticIp').value || '192.168.0.20',
                prefix_len: parseInt(document.getElementById('staticPrefixLen').value) || 24
            };
            
            config.wifi = { ssid, password: password || null };
            config.ip = ipConfig;
            
            setButtonLoading('btnSaveWifi', true, 'Connecting...');
            try {
                const response = await fetch('/api/wifi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ssid, password: password || null, ip: ipConfig })
                });
                
                if (response.ok) {
                    showStatus('WiFi saved! Device will restart and connect to ' + ssid, false);
                    setTimeout(() => {
                        showStatus('Restarting device...', false);
                    }, 2000);
                } else {
                    showStatus('Failed to save WiFi configuration', true);
                }
            } catch (error) {
                showStatus('Error: ' + error.message, true);
            } finally {
                setButtonLoading('btnSaveWifi', false);
            }
        }

        async function scanWifi() {
            setButtonLoading('btnScanWifi', true, 'Scanning...');
            try {
                const response = await fetch('/api/wifi/scan');
                if (response.ok) {
                    const networks = await response.json();
                    const container = document.getElementById('wifiNetworks');
                    if (networks.length === 0) {
                        container.innerHTML = '<p>No networks found</p>';
                    } else {
                        container.innerHTML = '<p>Available networks (click to select):</p>' +
                            networks.map(n => 
                                '<button onclick="document.getElementById(\'wifiSsid\').value=\'' + n.ssid + '\'" style="margin: 2px; padding: 5px 10px;">' +
                                    n.ssid +
                                '</button>'
                            ).join('');
                    }
                } else {
                    showStatus('Failed to scan networks', true);
                }
            } catch (error) {
                showStatus('Error: ' + error.message, true);
            } finally {
                setButtonLoading('btnScanWifi', false);
            }
        }

        async function rebootDevice() {
            if (!confirm('Are you sure you want to reboot the device?')) {
                return;
            }
            
            setButtonLoading('btnReboot', true, 'Rebooting...');
            try {
                const response = await fetch('/api/reboot', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    showStatus('Device is rebooting...', false);
                    // Disable the button since device is restarting
                    document.getElementById('btnReboot').disabled = true;
                } else {
                    showStatus('Failed to reboot device', true);
                    setButtonLoading('btnReboot', false);
                }
            } catch (error) {
                // Expected to fail as device disconnects
                showStatus('Device is rebooting...', false);
            }
        }

        async function loadConfig() {
            setButtonLoading('btnReload', true, 'Loading...');
            try {
                const response = await fetch('/api/config');
                if (response.ok) {
                    config = await response.json();
                    document.getElementById('totalLeds').value = config.total_leds;
                    document.getElementById('ledGpio').value = config.led_gpio || 48;
                    document.getElementById('wifiSsid').value = config.wifi?.ssid || '';
                    document.getElementById('wifiPassword').value = config.wifi?.password || '';
                    
                    // IP config
                    const ipConfig = config.ip || { use_dhcp: true, prefix_len: 24 };
                    document.getElementById('ipMode').value = ipConfig.use_dhcp ? 'dhcp' : 'static';
                    document.getElementById('staticIp').value = ipConfig.ip || '';
                    document.getElementById('staticPrefixLen').value = ipConfig.prefix_len || 24;
                    toggleStaticIp();
                    
                    // OBD2 config
                    const obd2Config = config.obd2 || { dongle_ip: '192.168.0.10', dongle_port: 35000, listen_port: 35000 };
                    document.getElementById('obd2DongleIp').value = obd2Config.dongle_ip || '192.168.0.10';
                    document.getElementById('obd2DonglePort').value = obd2Config.dongle_port || 35000;
                    document.getElementById('obd2ListenPort').value = obd2Config.listen_port || 35000;
                    document.getElementById('obd2SlowPollMode').value = obd2Config.slow_poll_mode || 'ratio';
                    document.getElementById('obd2SlowPollMs').value = obd2Config.slow_poll_interval_ms || 450;
                    document.getElementById('obd2SlowPollRatio').value = obd2Config.slow_poll_ratio || 6;
                    document.getElementById('obd2PromotionThreshold').value = obd2Config.promotion_wait_threshold_ms || 20;
                    document.getElementById('obd2FastDemotionMs').value = obd2Config.fast_demotion_ms || 2000;
                    document.getElementById('obd2PidRemovalMs').value = obd2Config.pid_inactive_removal_ms || 4000;
                    document.getElementById('obd2TestMultiPid').checked = obd2Config.test_multi_pid || false;
                    toggleSlowPollMode();
                    
                    // Log level
                    document.getElementById('logLevel').value = config.log_level || 'info';
                    
                    // Debug dump options
                    document.getElementById('dumpCpuMetrics').checked = config.dump_cpu_metrics || false;
                    document.getElementById('dumpSocketInfo').checked = config.dump_socket_info || false;
                    
                    // AP config
                    document.getElementById('apSsid').value = config.ap_ssid || '';
                    document.getElementById('apPassword').value = config.ap_password || '';
                    document.getElementById('apIp').value = config.ap_ip || '10.15.25.1';
                    document.getElementById('apPrefixLen').value = config.ap_prefix_len || 24;
                    
                    // OBD2 timeout
                    document.getElementById('obd2TimeoutMs').value = config.obd2_timeout_ms || 4500;
                    
                    // Brightness
                    const brightness = config.brightness !== undefined ? config.brightness : 255;
                    document.getElementById('brightnessSlider').value = brightness;
                    document.getElementById('brightnessValue').textContent = brightness;
                    
                    renderThresholds();
                    showStatus('Configuration loaded!', false);
                } else {
                    showStatus('Failed to load configuration', true);
                }
            } catch (error) {
                showStatus('Error: ' + error.message, true);
            } finally {
                setButtonLoading('btnReload', false);
            }
        }

        // Track SSE connection state for diagram
        let sseConnected = false;
        // Track HTTP connection state (based on API response success)
        let httpConnected = true;

        function updateHttpStatus(connected) {
            const wasDisconnected = !httpConnected;
            httpConnected = connected;
            document.getElementById('connHttp').className = 'connector-line' + (connected ? ' active' : ' error');
            document.getElementById('labelHttp').className = 'connector-label' + (connected ? ' active' : ' error');
            
            // When HTTP is down, set everything else to unknown (grey)
            if (!connected) {
                // WiFi - unknown
                document.getElementById('connWifi').className = 'connector-line';
                document.getElementById('labelWifi').className = 'connector-label';
                // TCP to dongle - unknown
                document.getElementById('connTcp').className = 'connector-line';
                document.getElementById('labelTcp').className = 'connector-label';
                // Nodes - unknown
                document.getElementById('nodeDongle').className = 'diagram-node';
                document.getElementById('nodeDevice').className = 'diagram-node';
                // OBD2 client TCP - unknown
                document.getElementById('connTcpClient').className = 'connector-line';
                document.getElementById('labelTcpClient').className = 'connector-label';
                document.getElementById('nodeObd2Client').className = 'diagram-node';
                document.getElementById('obd2ClientCount').textContent = '?';
                // SSE - will be handled by its own error handler
                document.getElementById('connSse').className = 'connector-line';
                document.getElementById('labelSse').className = 'connector-label';
                // Browser node stays active (we're running in it)
            } else if (wasDisconnected) {
                // HTTP just came back online - refresh connection status immediately
                loadConnectionStatus();
            }
        }

        function updateConnectionDiagram(status) {
            // Only update if HTTP is connected (otherwise status is stale/unknown)
            if (!httpConnected) return;
            
            // Update WiFi connection - error if explicitly disconnected
            const wifiActive = status.wifi_connected;
            document.getElementById('connWifi').className = 'connector-line' + (wifiActive ? ' active' : ' error');
            document.getElementById('labelWifi').className = 'connector-label' + (wifiActive ? ' active' : ' error');
            
            // Update TCP connection to dongle - error if explicitly disconnected
            const tcpActive = status.dongle_tcp_connected;
            document.getElementById('connTcp').className = 'connector-line' + (tcpActive ? ' active' : ' error');
            document.getElementById('labelTcp').className = 'connector-label' + (tcpActive ? ' active' : ' error');
            
            // Update dongle node (active if TCP connected)
            document.getElementById('nodeDongle').className = 'diagram-node' + (tcpActive ? ' active' : '');
            
            // Update device node (active if WiFi connected)
            document.getElementById('nodeDevice').className = 'diagram-node' + (wifiActive ? ' active' : '');
            
            // Update OBD2 client TCP connection (diagonal) - grey when no clients (not error)
            const clientCount = status.obd2_client_count || 0;
            const clientActive = clientCount > 0;
            document.getElementById('connTcpClient').className = 'connector-line' + (clientActive ? ' active' : '');
            document.getElementById('labelTcpClient').className = 'connector-label' + (clientActive ? ' active' : '');
            document.getElementById('nodeObd2Client').className = 'diagram-node' + (clientActive ? ' active' : '');
            document.getElementById('obd2ClientCount').textContent = clientCount;
            
            // Update SSE connection
            document.getElementById('connSse').className = 'connector-line' + (sseConnected ? ' active' : '');
            document.getElementById('labelSse').className = 'connector-label' + (sseConnected ? ' active' : '');
        }

        async function loadConnectionStatus() {
            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 3000);
                const response = await fetch('/api/status', { signal: controller.signal });
                clearTimeout(timeout);
                if (response.ok) {
                    const status = await response.json();
                    updateConnectionDiagram(status);
                }
            } catch (error) {
                console.error('Failed to load connection status:', error);
            }
        }

        function toggleNetworkDetails() {
            const details = document.getElementById('networkDetails');
            const tcpDetails = document.getElementById('tcpDetails');
            tcpDetails.classList.remove('visible');
            details.classList.toggle('visible');
        }

        function toggleTcpDetails() {
            const details = document.getElementById('tcpDetails');
            const netDetails = document.getElementById('networkDetails');
            netDetails.classList.remove('visible');
            details.classList.toggle('visible');
            if (details.classList.contains('visible')) {
                loadTcpStatus();
            }
        }

        async function loadTcpStatus() {
            try {
                const response = await fetch('/api/tcp');
                if (response.ok) {
                    const data = await response.json();
                    // Dongle connection
                    if (data.dongle) {
                        document.getElementById('tcpDongleRemote').textContent = data.dongle.remote || '---';
                        document.getElementById('tcpDongleLocal').textContent = data.dongle.local || '---';
                    } else {
                        document.getElementById('tcpDongleRemote').textContent = 'Not connected';
                        document.getElementById('tcpDongleLocal').textContent = '---';
                    }
                    // Client connections
                    const clientList = document.getElementById('tcpClientList');
                    if (data.clients && data.clients.length > 0) {
                        clientList.innerHTML = data.clients.map((c, i) => 
                            `<div class="info-row"><span>#${i+1}:</span><span>${c.remote} ‚Üí ${c.local}</span></div>`
                        ).join('');
                    } else {
                        clientList.textContent = 'No clients connected';
                    }
                }
            } catch (error) {
                console.error('Failed to load TCP status:', error);
            }
        }

        async function loadNetworkStatus() {
            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 3000);
                const response = await fetch('/api/network', { signal: controller.signal });
                clearTimeout(timeout);
                if (response.ok) {
                    updateHttpStatus(true);
                    const data = await response.json();
                    document.getElementById('netSsid').textContent = data.ssid || '---';
                    document.getElementById('netIp').textContent = data.ip || '---';
                    document.getElementById('netMac').textContent = data.mac || '---';
                    if (data.rssi !== null && data.rssi !== undefined) {
                        let quality;
                        if (data.rssi >= -50) quality = 'Excellent';
                        else if (data.rssi >= -60) quality = 'Good';
                        else if (data.rssi >= -70) quality = 'Fair';
                        else if (data.rssi >= -80) quality = 'Weak';
                        else quality = 'Poor';
                        document.getElementById('netRssi').textContent = quality + ' (' + data.rssi + ' dBm)';
                    } else {
                        document.getElementById('netRssi').textContent = '---';
                    }
                } else {
                    updateHttpStatus(false);
                }
            } catch (error) {
                console.error('Failed to load network status:', error);
                updateHttpStatus(false);
            }
        }

        async function loadRpm() {
            try {
                const response = await fetch('/api/rpm');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('currentRpm').textContent = data.rpm !== null ? data.rpm : '---';
                }
            } catch (error) {
                console.error('Failed to poll RPM:', error);
            }
        }

        let rpmEventSource = null;
        let rpmPollInterval = null;

        function startRpmPolling() {
            if (!rpmPollInterval) {
                rpmPollInterval = setInterval(loadRpm, 500);
                loadRpm(); // Immediate first poll
            }
        }

        function stopRpmPolling() {
            if (rpmPollInterval) {
                clearInterval(rpmPollInterval);
                rpmPollInterval = null;
            }
        }

        function setupRpmEventSource() {
            // Close existing connection if any
            if (rpmEventSource) {
                rpmEventSource.close();
                rpmEventSource = null;
            }

            // SSE runs on a separate port to avoid blocking the HTTP server
            const sseUrl = `http://${window.location.hostname}:${SSE_PORT}/`;
            rpmEventSource = new EventSource(sseUrl);
            rpmEventSource.onopen = function() {
                sseConnected = true;
                stopRpmPolling(); // SSE connected, stop polling
                // Update diagram immediately
                document.getElementById('connSse').className = 'connector-line active';
                document.getElementById('labelSse').className = 'connector-label active';
            };
            rpmEventSource.onmessage = function(event) {
                sseConnected = true;
                stopRpmPolling(); // SSE working, ensure polling stopped
                const data = JSON.parse(event.data);
                document.getElementById('currentRpm').textContent = data.rpm !== null ? data.rpm : '---';
            };
            rpmEventSource.onerror = function() {
                sseConnected = false;
                startRpmPolling(); // SSE failed, start polling fallback
                // Update diagram immediately
                document.getElementById('connSse').className = 'connector-line';
                document.getElementById('labelSse').className = 'connector-label';
                // EventSource will automatically reconnect
            };
            // Listen for metrics events (separate from RPM messages)
            rpmEventSource.addEventListener('metrics', function(event) {
                const data = JSON.parse(event.data);
                document.getElementById('metricsFastPids').textContent = data.fast_pids;
                document.getElementById('metricsSlowPids').textContent = data.slow_pids;
                document.getElementById('metricsReqsPerSec').textContent = data.reqs_per_sec;
            });
        }

        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        async function loadRawConfig() {
            setButtonLoading('btnReloadRawConfig', true, 'Loading...');
            try {
                const response = await fetch('/api/config');
                if (response.ok) {
                    const cfg = await response.json();
                    document.getElementById('rawConfigJson').value = JSON.stringify(cfg, null, 2);
                    showStatus('Raw config loaded!', false);
                } else {
                    showStatus('Failed to load raw config', true);
                }
            } catch (error) {
                showStatus('Error: ' + error.message, true);
            } finally {
                setButtonLoading('btnReloadRawConfig', false);
            }
        }

        async function saveRawConfig() {
            const textarea = document.getElementById('rawConfigJson');
            let parsed;
            try {
                parsed = JSON.parse(textarea.value);
            } catch (e) {
                showStatus('Invalid JSON: ' + e.message, true);
                return;
            }
            
            setButtonLoading('btnSaveRawConfig', true, 'Saving...');
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(parsed)
                });
                
                if (response.ok) {
                    const result = await response.json().catch(() => ({}));
                    if (result.restart) {
                        showStatus('Raw config saved! Restarting device...', false);
                    } else {
                        showStatus('Raw config saved! Reloading page config...', false);
                        // Reload the main config to sync UI
                        loadConfig();
                    }
                } else {
                    showStatus('Failed to save raw config (server rejected)', true);
                }
            } catch (error) {
                showStatus('Error: ' + error.message, true);
            } finally {
                setButtonLoading('btnSaveRawConfig', false);
            }
        }

        function formatRawConfig() {
            const textarea = document.getElementById('rawConfigJson');
            try {
                const parsed = JSON.parse(textarea.value);
                textarea.value = JSON.stringify(parsed, null, 2);
                showStatus('JSON formatted!', false);
            } catch (e) {
                showStatus('Invalid JSON: ' + e.message, true);
            }
        }

        async function loadDebugInfo() {
            try {
                const response = await fetch('/api/debug_info');
                const info = await response.json();
                
                document.getElementById('freeHeap').textContent = formatBytes(info.free_heap);
                document.getElementById('minFreeHeap').textContent = formatBytes(info.min_free_heap);
                
                const el = document.getElementById('atCommands');
                if (info.at_commands.length === 0) {
                    el.textContent = '(none yet)';
                } else {
                    el.textContent = info.at_commands.join(', ');
                }
                
                const pidEl = document.getElementById('pids');
                if (info.pids.length === 0) {
                    pidEl.textContent = '(none yet)';
                } else {
                    pidEl.textContent = info.pids.join(', ');
                }
            } catch (e) {
                document.getElementById('atCommands').textContent = '(error)';
                document.getElementById('pids').textContent = '(error)';
                document.getElementById('freeHeap').textContent = '---';
                document.getElementById('minFreeHeap').textContent = '---';
            }
        }

        // Initialize
        renderThresholds();
        loadConfig();
        loadNetworkStatus();
        loadConnectionStatus();
        setupRpmEventSource();
        loadDebugInfo();
        
        // Load raw config when that section is opened
        document.querySelectorAll('.debug-section').forEach(details => {
            details.addEventListener('toggle', (e) => {
                if (e.target.open && e.target.querySelector('#rawConfigJson')) {
                    loadRawConfig();
                }
            });
        });
        
        // Poll network status and connection status
        setInterval(loadNetworkStatus, 5000);
        setInterval(loadConnectionStatus, 2000);
        // Poll debug info every second (only when debug section is open)
        setInterval(() => {
            const debugSection = document.querySelector('.debug-section:has(#freeHeap)');
            if (debugSection && debugSection.open) loadDebugInfo();
        }, 1000);
    </script>
</body>
</html>