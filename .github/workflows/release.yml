name: Build and Release Firmware

on:
  push:
    tags: ["v*.*.*"]

permissions:
  contents: write

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  RUSTC_WRAPPER: sccache

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache Xtensa toolchain
        id: cache-xtensa
        uses: actions/cache@v4
        with:
          path: |
            ~/.rustup/toolchains/esp
            ~/.espup
            ~/exports
          key: xtensa-toolchain-${{ runner.os }}

      - name: Install Rust (Xtensa)
        uses: esp-rs/xtensa-toolchain@v1.6
        with:
          default: true
          ldproxy: true

      - name: Set up sccache
        uses: mozilla-actions/sccache-action@v0.0.7

      - name: Install espflash
        run: |
          curl -L "https://github.com/esp-rs/espflash/releases/latest/download/espflash-x86_64-unknown-linux-gnu.zip" \
            -o "$HOME/.cargo/bin/espflash.zip"
          unzip "$HOME/.cargo/bin/espflash.zip" -d "$HOME/.cargo/bin/"
          chmod a+x "$HOME/.cargo/bin/espflash"

      - name: Cache
        uses: Swatinem/rust-cache@v2
        with:
          # Cache both firmware target dirs and the shared workspace target dir
          workspaces: |
            . -> target
            tachtalk-firmware -> target
            tachtalk-test-firmware -> target

      - name: Build regular firmware
        working-directory: tachtalk-firmware
        run: cargo build --release

      - name: Build test firmware
        working-directory: tachtalk-test-firmware
        run: cargo build --release

      - name: Convert to binary images
        run: |
          espflash save-image --chip esp32s3 --flash-size 16mb \
            tachtalk-firmware/target/xtensa-esp32s3-espidf/release/tachtalk \
            tachtalk-firmware-${{ github.ref_name }}.bin

          espflash save-image --chip esp32s3 --flash-size 16mb \
            tachtalk-test-firmware/target/xtensa-esp32s3-espidf/release/tachtalk-test \
            tachtalk-test-firmware-${{ github.ref_name }}.bin

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # Tags containing a hyphen are pre-releases (e.g. v0.2.0-beta.1)
          prerelease: ${{ contains(github.ref_name, '-') }}
          generate_release_notes: true
          files: |
            tachtalk-firmware-${{ github.ref_name }}.bin
            tachtalk-test-firmware-${{ github.ref_name }}.bin
